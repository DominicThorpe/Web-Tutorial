{% extends "base.html" %}
{% block content %}
  <h1 class="mb-3">{{ context.title }}</h1>
  <div class="d-flex">
    <a href="{{ url_for('field_edit', field_id=context.field.id) }}" class="btn btn-primary me-2">Edit</a>
    <a href="{{ url_for('field_delete', field_id=context.field.id) }}" class="btn btn-danger">Delete</a>
  </div>

  <!-- KPIs -->
  <section class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card shadow-soft h-100">
        <div class="card-body kpi">
          <div class="small-label">Area</div>
          <div class="display-6 fw-semibold">{{ context.field.area }}</div>
          <div class="text-muted">hectares</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card shadow-soft h-100">
        <div class="card-body kpi">
          <div class="small-label">Soil type</div>
          <div class="h4 mb-1 fw-semibold">{{ context.field.soilType }}</div>
          <div class="text-muted">{{ context.field.drainage }} drainage</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card shadow-soft h-100">
        <div class="card-body kpi">
          <div class="small-label">Last operation</div>
          {% if context.field.operations[0] %}
            <div class="h5 mb-1 fw-semibold">{{ context.field.operations[0].operation }}</div>
            <div class="text-muted">{{ context.field.operations[0].date }}</div>
          {% else %}
            <div class="h5 mb-1 fw-semibold">No previous actions</div>
            <div class="text-muted">N/A</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card shadow-soft h-100">
        <div class="card-body kpi">
          <div class="small-label">Risk flag</div>
          <div class="h4 mb-1 fw-semibold">{{ context.field.risk }}</div>
          <div class="text-muted">Watch lodging</div>
        </div>
      </div>
    </div>
  </section>

  <section class="row g-3">
    <!-- Left column: field details -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-soft mb-3">
        <div class="card-body">
          <h2 class="h5 mb-3">Field Details</h2>
          <ul class="list-unstyled list-tight mb-0">
            <li><strong>Crop:</strong> {{ context.field.crop_rel.name }}</li>
            <li><strong>Sowing date:</strong> {{ context.field.sowingDate }}</li>
            <li><strong>Target yield:</strong> {{ context.field.crop_rel.targetYield }} t/ha</li>
            <li><strong>Irrigation:</strong> {{ context.field.irrigation }}</li>
            <li><strong>Drainage:</strong> {{ context.field.drainage }}</li>
            <li><strong>pH (last test):</strong> {{ context.field.pH }}</li>
            <li><strong>Organic matter:</strong> {{ context.field.SOM }}%</li>
          </ul>
        </div>
      </div>

      <div class="card shadow-soft mb-3">
        <div class="card-body">
          <h2 class="h5 mb-3">Notes</h2>
          <p class="mb-0 text-muted">
            {{ context.field.notes }}
          </p>
        </div>
      </div>
    </div>

    <!-- Right column: charts + logs -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-soft mb-3">
        <div class="card-body">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
            <div>
              <h2 class="h5 mb-0">Rainfall (last 14 days)</h2>
              <div class="text-muted small">Source: DEFRA (Environment Agency) Data Services Platform</div>
            </div>
            <div class="text-muted small">
              Units: Rainfall (mm/day)
            </div>
          </div>

          <div class="chart-wrap">
            <canvas id="fieldChart" aria-label="Rainfall chart" role="img"></canvas>
          </div>
        </div>
      </div>

      <div class="card shadow-soft mb-4">
        <div class="card-body">
          <h2 class="h5 mb-3">Operations Log</h2>
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 100px;">Date</th>
                  <th>Operation</th>
                  <th>Product / Detail</th>
                  <th>Rate</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for operation in context.field.operations %}
                  <tr>
                    <td>{{ operation.date }}</td>
                    <td>{{ operation.operation }}</td>
                    <td>{{ operation.detail }}</td>
                    <td>{{ operation.rate }}</td>
                    <td><a href="{{ url_for('operation_delete', operation_id=operation.id) }}" class="btn btn-sm btn-danger">Delete</a></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            <a href="{{ url_for('operation_new', field_id=context.field.id) }}" class="btn btn-success mt-3">Add Operation</a>
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}


{% block scripts %}
  <script>
    function create_chart(rainfallMm) {
      const labels = Object.keys(rainfallMm);
      const ctx = document.getElementById("fieldChart");

      new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Rainfall (mm/day)",
              data: Object.values(rainfallMm),
              yAxisID: "yRain",
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { mode: "index", intersect: false }
          },
          interaction: { mode: "index", intersect: false },
          scales: {
            yRain: {
              beginAtZero: true,
              title: { display: true, text: "Rainfall (mm)" }
            }
          }
        }
      });
    }

    function get_rainfall() {
      return new Promise((resolve, reject) => {
        const today = new Date().getDate();
        const fourteenDaysAgo = new Date();
        fourteenDaysAgo.setDate(today - 14);

        const url = `https://environment.data.gov.uk/flood-monitoring/id/stations/296705/readings?since=${fourteenDaysAgo.toISOString()}&_limit=2000`;
        try {
            const response = fetch(url)
              .then(response => {
                if (!response.ok) {
                      throw new Error(`Response status: ${response.status}`);
                  }

                  return response.json();
              })
              .then (result => {
                resolve(result.items)
              })
              .catch(error => {
                reject(error)
              })
        } catch (error) {
            console.error(error.message);
        }
      })
  };

  function process_rainfall(readings) {
    const grouped = {};
    for (const record of readings) {
      const day = record.dateTime.slice(0, 10); // "YYYY-MM-DD"
      if (!grouped[day]) {
        grouped[day] = [];
      }

      grouped[day].push(record);
    }

    const processed = {}
    for (const day in grouped) {
      processed[day] = grouped[day].reduce((acc, r) => acc + r.value, 0);
    }

    return processed
  }

  get_rainfall()
    .then(readings => create_chart(process_rainfall(readings)))
    .catch(err => console.error(err));
  </script>
{% endblock %}