<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FarmApp | {{ context.title }}</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- Top bar -->
  <header class="dashboard-header">
    <div class="container">
      <h1 class="mb-1">Generica Farms</h1>
      <p class="mb-0">Basic Farm Dashboard</p>
    </div>
  </header>

  <main class="container pb-5">
    <h1 class="mb-3">{{ context.title }}</h1>

    <!-- KPIs -->
    <section class="row g-3 mb-4">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-soft h-100">
          <div class="card-body kpi">
            <div class="small-label">Area</div>
            <div class="display-6 fw-semibold">{{ context.field.area }}</div>
            <div class="text-muted">hectares</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-soft h-100">
          <div class="card-body kpi">
            <div class="small-label">Soil type</div>
            <div class="h4 mb-1 fw-semibold">{{ context.field.soilType }}</div>
            <div class="text-muted">{{ context.field.drainage }} drainage</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-soft h-100">
          <div class="card-body kpi">
            <div class="small-label">Last operation</div>
            <div class="h5 mb-1 fw-semibold">N top dressing</div>
            <div class="text-muted">12 Mar 2025</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card shadow-soft h-100">
          <div class="card-body kpi">
            <div class="small-label">Risk flag</div>
            <div class="h4 mb-1 fw-semibold">{{ context.field.risk }}</div>
            <div class="text-muted">Watch lodging</div>
          </div>
        </div>
      </div>
    </section>

    <section class="row g-3">
      <!-- Left column: field details -->
      <div class="col-12 col-lg-4">
        <div class="card shadow-soft mb-3">
          <div class="card-body">
            <h2 class="h5 mb-3">Field Details</h2>
            <ul class="list-unstyled list-tight mb-0">
              <li><strong>Crop:</strong> {{ context.field.crop_rel.name }}</li>
              <li><strong>Sowing date:</strong> 18 Oct 2024</li>
              <li><strong>Target yield:</strong> {{ context.field.crop_rel.targetYield }} t/ha</li>
              <li><strong>Irrigation:</strong> {{ context.field.irrigation }}</li>
              <li><strong>Drainage:</strong> {{ context.field.drainage }}</li>
              <li><strong>pH (last test):</strong> {{ context.field.pH }}</li>
              <li><strong>Organic matter:</strong> {{ context.field.SOM }}%</li>
            </ul>
          </div>
        </div>

        <div class="card shadow-soft mb-3">
          <div class="card-body">
            <h2 class="h5 mb-3">Notes</h2>
            <p class="mb-0 text-muted">
              Historically high yield. Monitor for lodging after heavy rain and
              strong winds. Consider growth regulator if canopy gets dense.
            </p>
          </div>
        </div>
      </div>

      <!-- Right column: charts + logs -->
      <div class="col-12 col-lg-8">
        <div class="card shadow-soft mb-3">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
              <div>
                <h2 class="h5 mb-0">Rainfall (last 14 days)</h2>
                <div class="text-muted small">Source: DEFRA (Environment Agency) Data Services Platform</div>
              </div>
              <div class="text-muted small">
                Units: Rainfall (mm/day)
              </div>
            </div>

            <div class="chart-wrap">
              <canvas id="fieldChart" aria-label="Rainfall chart" role="img"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-soft">
          <div class="card-body">
            <h2 class="h5 mb-3">Operations Log</h2>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 140px;">Date</th>
                    <th>Operation</th>
                    <th style="width: 160px;">Product / Detail</th>
                    <th style="width: 120px;">Rate</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>12 Mar 2025</td>
                    <td>N top dressing</td>
                    <td>Ammonium nitrate</td>
                    <td>70 kg N/ha</td>
                  </tr>
                  <tr>
                    <td>26 Feb 2025</td>
                    <td>Herbicide</td>
                    <td>Broadleaf mix</td>
                    <td>Label rate</td>
                  </tr>
                  <tr>
                    <td>18 Oct 2024</td>
                    <td>Drilling</td>
                    <td>Winter wheat</td>
                    <td>180 kg/ha</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <script>
    function create_chart(rainfallMm) {
      const labels = Object.keys(rainfallMm);
      const ctx = document.getElementById("fieldChart");

      new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Rainfall (mm/day)",
              data: Object.values(rainfallMm),
              yAxisID: "yRain",
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "bottom" },
            tooltip: { mode: "index", intersect: false }
          },
          interaction: { mode: "index", intersect: false },
          scales: {
            yRain: {
              beginAtZero: true,
              title: { display: true, text: "Rainfall (mm)" }
            }
          }
        }
      });
    }

    function get_rainfall() {
      return new Promise((resolve, reject) => {
        const today = new Date().getDate();
        const fourteenDaysAgo = new Date();
        fourteenDaysAgo.setDate(today - 14);

        const url = `https://environment.data.gov.uk/flood-monitoring/id/stations/296705/readings?since=${fourteenDaysAgo.toISOString()}&_limit=2000`;
        try {
            const response = fetch(url)
              .then(response => {
                if (!response.ok) {
                      throw new Error(`Response status: ${response.status}`);
                  }

                  return response.json();
              })
              .then (result => {
                resolve(result.items)
              })
              .catch(error => {
                reject(error)
              })
        } catch (error) {
            console.error(error.message);
        }
      })
  };

  function process_rainfall(readings) {
    const grouped = {};
    for (const record of readings) {
      const day = record.dateTime.slice(0, 10); // "YYYY-MM-DD"
      if (!grouped[day]) {
        grouped[day] = [];
      }

      grouped[day].push(record);
    }

    const processed = {}
    for (const day in grouped) {
      processed[day] = grouped[day].reduce((acc, r) => acc + r.value, 0);
    }

    return processed
  }

  get_rainfall()
    .then(readings => create_chart(process_rainfall(readings)))
    .catch(err => console.error(err));
  </script>
</body>
</html>